<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<root file="DotNetNuke.Modules.CoreMessaging.dll" version="07.01.02" generated="2017-06-19 09:16:00Z" generationTime="2.0090407">
  <namespace name="DotNetNuke.Modules.CoreMessaging">
    <class name="View">
      <declaration><![CDATA[public class View : PortalModuleBase]]></declaration>
      <documentation>-----------------------------------------------------------------------------
 <summary>
 The View class displays the content
 </summary>
 -----------------------------------------------------------------------------</documentation>
      <constructors>
        <constructor name=".ctor">
          <declaration><![CDATA[public View()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="2147483647" sc="0" el="0" ec="0">
            </location>
            <body hash="d41d8cd98f00b204e9800998ecf8427e"><![CDATA[]]></body>
          </codeblock>
        </constructor>
      </constructors>
      <methods>
        <method name="AddIe7StyleSheet">
          <declaration><![CDATA[private void AddIe7StyleSheet()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="114" sc="9" el="121" ec="10">View.ascx.cs</location>
            <body hash="c30c4061e5e913e8822c126dad54b385"><![CDATA[{
            var browser = Request.Browser;
            if (browser.Type == "IE" || browser.MajorVersion < 8)
            {
                const string cssLink = "<link href=\"/ie-messages.css\" rel=\"stylesheet\" type=\"text/css\" />";
                Page.Header.Controls.Add(new LiteralControl(cssLink));
            }
        }]]></body>
          </codeblock>
        </method>
        <method name="OnInit">
          <declaration><![CDATA[protected override void OnInit(EventArgs e)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="79" sc="9" el="107" ec="10">View.ascx.cs</location>
            <body hash="13fb9fe700783318e043c52074c18bfa"><![CDATA[{
            if (!Request.IsAuthenticated)
            {
                // Do not redirect but hide the content of the module and display a message.
                CoreMessagingContainer.Visible = false;
                UI.Skins.Skin.AddModuleMessage(this, Localization.GetString("ContentNotAvailable", LocalResourceFile), ModuleMessage.ModuleMessageType.YellowWarning);
                return;
            }
            if (UserId != ProfileUserId && (PortalSettings.ActiveTab.ParentId == PortalSettings.UserTabId || TabId == PortalSettings.UserTabId))
            {
				// Do not redirect but hide the content of the module.
				CoreMessagingContainer.Visible = false;
				return;
            }
            
            if (IsEditable && PermissionsNotProperlySet())
            {
                UI.Skins.Skin.AddModuleMessage(this, Localization.GetString("PermissionsNotProperlySet", LocalResourceFile), ModuleMessage.ModuleMessageType.YellowWarning);
            }

            ServicesFramework.Instance.RequestAjaxScriptSupport();
            ServicesFramework.Instance.RequestAjaxAntiForgerySupport();
            jQuery.RequestDnnPluginsRegistration();
            ClientResourceManager.RegisterScript(Page, "~/DesktopModules/CoreMessaging/Scripts/CoreMessaging.js");
            jQuery.RequestDnnPluginsRegistration();
			jQuery.RegisterFileUpload(Page);
            AddIe7StyleSheet();
            base.OnInit(e);
        }]]></body>
          </codeblock>
        </method>
        <method name="PermissionPredicate">
          <declaration><![CDATA[private static bool PermissionPredicate(PermissionInfoBase p)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="141" sc="9" el="143" ec="10">View.ascx.cs</location>
            <body hash="bcc5123f2e95cd9dc4453be8693fb844"><![CDATA[{
            return p.PermissionKey == "VIEW" && p.AllowAccess && (p.RoleName == Globals.glbRoleAllUsersName || p.RoleName == Globals.glbRoleUnauthUserName);
        }]]></body>
          </codeblock>
        </method>
        <method name="PermissionsNotProperlySet">
          <declaration><![CDATA[private bool PermissionsNotProperlySet()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="124" sc="9" el="138" ec="10">View.ascx.cs</location>
            <body hash="811a83c483f13a23f8301f3549d04e48"><![CDATA[{
            List<PermissionInfoBase> permissions;

            if (ModuleConfiguration.InheritViewPermissions)
            {
                var tabPermissionCollection = TabPermissionController.GetTabPermissions(TabId, PortalId);
                permissions = tabPermissionCollection.ToList();
            }
            else
            {
                permissions = ModuleConfiguration.ModulePermissions.ToList();
            }

            return permissions.Find(PermissionPredicate) != null;
        }]]></body>
          </codeblock>
        </method>
      </methods>
      <fields>
        <field name="coreMessaging">
          <declaration><![CDATA[protected HtmlGenericControl coreMessaging;]]></declaration>
          <documentation>
            <summary>
 coreMessaging control.
 </summary>
 <remarks>
 Auto-generated field.
 To modify move field declaration from designer file to code-behind file.
 </remarks></documentation>
        </field>
        <field name="CoreMessagingContainer">
          <declaration><![CDATA[protected Panel CoreMessagingContainer;]]></declaration>
          <documentation>
            <summary>
 CoreMessagingContainer control.
 </summary>
 <remarks>
 Auto-generated field.
 To modify move field declaration from designer file to code-behind file.
 </remarks></documentation>
        </field>
        <field name="DnnCssInclude1">
          <declaration><![CDATA[protected DnnCssInclude DnnCssInclude1;]]></declaration>
          <documentation>
            <summary>
 DnnCssInclude1 control.
 </summary>
 <remarks>
 Auto-generated field.
 To modify move field declaration from designer file to code-behind file.
 </remarks></documentation>
        </field>
        <field name="DnnCssInclude2">
          <declaration><![CDATA[protected DnnCssInclude DnnCssInclude2;]]></declaration>
          <documentation>
            <summary>
 DnnCssInclude2 control.
 </summary>
 <remarks>
 Auto-generated field.
 To modify move field declaration from designer file to code-behind file.
 </remarks></documentation>
        </field>
        <field name="DnnCssInclude3">
          <declaration><![CDATA[protected DnnCssInclude DnnCssInclude3;]]></declaration>
          <documentation>
            <summary>
 DnnCssInclude3 control.
 </summary>
 <remarks>
 Auto-generated field.
 To modify move field declaration from designer file to code-behind file.
 </remarks></documentation>
        </field>
        <field name="DnnJsInclude1">
          <declaration><![CDATA[protected DnnJsInclude DnnJsInclude1;]]></declaration>
          <documentation>
            <summary>
 DnnJsInclude1 control.
 </summary>
 <remarks>
 Auto-generated field.
 To modify move field declaration from designer file to code-behind file.
 </remarks></documentation>
        </field>
        <field name="DnnJsInclude2">
          <declaration><![CDATA[protected DnnJsInclude DnnJsInclude2;]]></declaration>
          <documentation>
            <summary>
 DnnJsInclude2 control.
 </summary>
 <remarks>
 Auto-generated field.
 To modify move field declaration from designer file to code-behind file.
 </remarks></documentation>
        </field>
        <field name="DnnJsInclude3">
          <declaration><![CDATA[protected DnnJsInclude DnnJsInclude3;]]></declaration>
          <documentation>
            <summary>
 DnnJsInclude3 control.
 </summary>
 <remarks>
 Auto-generated field.
 To modify move field declaration from designer file to code-behind file.
 </remarks></documentation>
        </field>
        <field name="DnnJsInclude4">
          <declaration><![CDATA[protected DnnJsInclude DnnJsInclude4;]]></declaration>
          <documentation>
            <summary>
 DnnJsInclude4 control.
 </summary>
 <remarks>
 Auto-generated field.
 To modify move field declaration from designer file to code-behind file.
 </remarks></documentation>
        </field>
        <field name="DnnJsInclude5">
          <declaration><![CDATA[protected DnnJsInclude DnnJsInclude5;]]></declaration>
          <documentation>
            <summary>
 DnnJsInclude5 control.
 </summary>
 <remarks>
 Auto-generated field.
 To modify move field declaration from designer file to code-behind file.
 </remarks></documentation>
        </field>
        <field name="DnnJsInclude6">
          <declaration><![CDATA[protected DnnJsInclude DnnJsInclude6;]]></declaration>
          <documentation>
            <summary>
 DnnJsInclude6 control.
 </summary>
 <remarks>
 Auto-generated field.
 To modify move field declaration from designer file to code-behind file.
 </remarks></documentation>
        </field>
      </fields>
      <properties>
        <property name="ProfileUserId">
          <declaration><![CDATA[public int ProfileUserId]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="55" sc="13" el="62" ec="14">View.ascx.cs</location>
            <body hash="b54f995526c72617c67516af9667b32c"><![CDATA[{
                var userId = Null.NullInteger;
                if (!string.IsNullOrEmpty(Request.Params["UserId"]))
                {
                    userId = Int32.Parse(Request.Params["UserId"]);
                }
                return userId;
            }]]></body>
          </codeblock>
        </property>
        <property name="ShowAttachments">
          <declaration><![CDATA[public string ShowAttachments]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="68" sc="13" el="71" ec="14">View.ascx.cs</location>
            <body hash="a7d4ca3223aa4bdc8b710bf4688f7263"><![CDATA[{
                var allowAttachments = PortalController.GetPortalSetting("MessagingAllowAttachments", PortalId, "NO");
                return allowAttachments == "NO" ? "false" : "true";
            }]]></body>
          </codeblock>
        </property>
      </properties>
      <events>
      </events>
    </class>
  </namespace>
  <namespace name="DotNetNuke.Modules.CoreMessaging.Components">
    <class name="CoreMessagingBusinessController">
      <declaration><![CDATA[public class CoreMessagingBusinessController : IUpgradeable]]></declaration>
      <documentation>
      </documentation>
      <constructors>
        <constructor name=".ctor">
          <declaration><![CDATA[public CoreMessagingBusinessController()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="2147483647" sc="0" el="0" ec="0">
            </location>
            <body hash="d41d8cd98f00b204e9800998ecf8427e"><![CDATA[]]></body>
          </codeblock>
        </constructor>
        <constructor name=".cctor">
          <declaration><![CDATA[static CoreMessagingBusinessController()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="39" sc="6" el="39" ec="118">Components\CoreMessagingBusinessController.cs</location>
            <body hash="df0a3accb70c27711dd15f5fa1126749"><![CDATA[private static readonly ILog Logger = LoggerSource.Instance.GetLogger(typeof (CoreMessagingBusinessController))]]></body>
          </codeblock>
        </constructor>
      </constructors>
      <methods>
        <method name="UpgradeModule">
          <declaration><![CDATA[public string UpgradeModule(string Version)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="43" sc="9" el="92" ec="10">Components\CoreMessagingBusinessController.cs</location>
            <body hash="5f4159deaeb256ab971646562709e0f6"><![CDATA[{
            try
            {
                switch (Version)
                {
                    case "06.02.00":
                        var portalController = new PortalController();
                        var moduleController = new ModuleController();
                        var tabController = new TabController();

                        var moduleDefinition = ModuleDefinitionController.GetModuleDefinitionByFriendlyName("Message Center");
                        if (moduleDefinition != null)
                        {
                            var portals = portalController.GetPortals();
                            foreach (PortalInfo portal in portals)
                            {
                                if (portal.UserTabId > Null.NullInteger)
                                {
                                    //Find TabInfo
                                    var tab = tabController.GetTab(portal.UserTabId, portal.PortalID, true);
                                    if (tab != null)
                                    {
                                        foreach (var module in moduleController.GetTabModules(portal.UserTabId).Values)
                                        {
                                            if (module.DesktopModule.FriendlyName == "Messaging")
                                            {
                                                //Delete the Module from the Modules list
                                                moduleController.DeleteTabModule(module.TabID, module.ModuleID, false);

                                                //Add new module to the page
                                                Upgrade.AddModuleToPage(tab, moduleDefinition.ModuleDefID, "Message Center", "", true);

                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        break;
                }
                return "Success";
            }
            catch (Exception exc)
            {
                Logger.Error(exc);

                return "Failed";
            }
        }]]></body>
          </codeblock>
        </method>
      </methods>
      <fields>
        <field name="Logger">
          <declaration><![CDATA[private static readonly ILog Logger = LoggerSource.Instance.GetLogger(typeof(CoreMessagingBusinessController));]]></declaration>
          <documentation>
          </documentation>
        </field>
      </fields>
      <properties>
      </properties>
      <events>
      </events>
    </class>
  </namespace>
  <namespace name="DotNetNuke.Modules.CoreMessaging.Services">
    <class name="CoreMessagingRouteMapper">
      <declaration><![CDATA[public sealed class CoreMessagingRouteMapper : IServiceRouteMapper]]></declaration>
      <documentation>
      </documentation>
      <constructors>
        <constructor name=".ctor">
          <declaration><![CDATA[public CoreMessagingRouteMapper()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="2147483647" sc="0" el="0" ec="0">
            </location>
            <body hash="d41d8cd98f00b204e9800998ecf8427e"><![CDATA[]]></body>
          </codeblock>
        </constructor>
      </constructors>
      <methods>
        <method name="RegisterRoutes">
          <declaration><![CDATA[public void RegisterRoutes(IMapRoute mapRouteManager)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="29" sc="9" el="31" ec="10">Services\CoreMessagingRouteMapper.cs</location>
            <body hash="efdfb7dc18f471cbd115a004c599482e"><![CDATA[{
            mapRouteManager.MapHttpRoute("CoreMessaging", "default", "{controller}/{action}", new[] { "DotNetNuke.Modules.CoreMessaging.Services" });
        }]]></body>
          </codeblock>
        </method>
      </methods>
      <fields>
      </fields>
      <properties>
      </properties>
      <events>
      </events>
    </class>
    <class name="FilesStatus">
      <declaration><![CDATA[public class FilesStatus]]></declaration>
      <documentation>
      </documentation>
      <constructors>
        <constructor name=".ctor">
          <declaration><![CDATA[public FilesStatus()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="18" sc="3" el="20" ec="4">Services\FilesStatus.cs</location>
            <body hash="0161c46de6c5ac3081f76634fcda532f"><![CDATA[public FilesStatus ()
		{
		}]]></body>
          </codeblock>
        </constructor>
      </constructors>
      <methods>
      </methods>
      <fields>
      </fields>
      <properties>
        <property name="extension">
          <declaration><![CDATA[public string extension]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="id">
          <declaration><![CDATA[public int id]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="message">
          <declaration><![CDATA[public string message]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="name">
          <declaration><![CDATA[public string name]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="progress">
          <declaration><![CDATA[public string progress]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="size">
          <declaration><![CDATA[public int size]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="success">
          <declaration><![CDATA[public bool success]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="thumbnail_url">
          <declaration><![CDATA[public string thumbnail_url]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="type">
          <declaration><![CDATA[public string type]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="url">
          <declaration><![CDATA[public string url]]></declaration>
          <documentation>
          </documentation>
        </property>
      </properties>
      <events>
      </events>
    </class>
    <class name="FileUploadController">
      <declaration><![CDATA[public class FileUploadController : DnnApiController]]></declaration>
      <documentation>
      </documentation>
      <constructors>
        <constructor name=".ctor">
          <declaration><![CDATA[private readonly IFileManager _fileManager = ComponentBase<IFileManager, FileManager>.Instance;]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="44" sc="9" el="45" ec="81">Services\FileUploadController.cs</location>
            <body hash="e4c09cf2bf297cb4d069e31b95171523"><![CDATA[private readonly IFileManager _fileManager = FileManager.Instance;
        private readonly IFolderManager _folderManager = FolderManager.Instance;]]></body>
          </codeblock>
        </constructor>
        <constructor name=".cctor">
          <declaration><![CDATA[static FileUploadController()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="43" sc="6" el="43" ec="107">Services\FileUploadController.cs</location>
            <body hash="2d75a63969b56745521ff57ad08e3fa4"><![CDATA[private static readonly ILog Logger = LoggerSource.Instance.GetLogger(typeof (FileUploadController))]]></body>
          </codeblock>
        </constructor>
      </constructors>
      <methods>
        <method name="IframeSafeJson">
          <declaration><![CDATA[private HttpResponseMessage IframeSafeJson(List<FilesStatus> statuses)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="67" sc="9" el="73" ec="10">Services\FileUploadController.cs</location>
            <body hash="c46a28e4e32e4facdc07ee14df479061"><![CDATA[{
            //return json but label it as plain text
            return new HttpResponseMessage
            {
                Content = new StringContent(JsonConvert.SerializeObject(statuses))
            };
        }]]></body>
          </codeblock>
        </method>
        <method name="IsAllowedExtension">
          <declaration><![CDATA[private static bool IsAllowedExtension(string fileName)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="76" sc="9" el="85" ec="10">Services\FileUploadController.cs</location>
            <body hash="52cd33d0f5448d4cc29a95cb94e5c3df"><![CDATA[{
            var extension = Path.GetExtension(fileName);

            //regex matches a dot followed by 1 or more chars followed by a semi-colon
            //regex is meant to block files like "foo.asp;.png" which can take advantage
            //of a vulnerability in IIS6 which treasts such files as .asp, not .png
            return !string.IsNullOrEmpty(extension)
                   && Host.AllowedExtensionWhitelist.IsAllowedExtension(extension)
                   && !Regex.IsMatch(fileName, @"\..+;");
        }]]></body>
          </codeblock>
        </method>
        <method name="UploadFile">
          <declaration><![CDATA[public HttpResponseMessage UploadFile()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="51" sc="9" el="64" ec="10">Services\FileUploadController.cs</location>
            <body hash="d4d45820afee36bc15dc5e3645d26049"><![CDATA[{
            var statuses = new List<FilesStatus>();
            try
            {
                //todo can we eliminate the HttpContext here
                UploadWholeFile(HttpContextSource.Current, statuses);
            }
            catch (Exception exc)
            {
                Logger.Error(exc);
            }

            return IframeSafeJson(statuses);
        }]]></body>
          </codeblock>
        </method>
        <method name="UploadWholeFile">
          <declaration><![CDATA[private void UploadWholeFile(HttpContextBase context, ICollection<FilesStatus> statuses)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="89" sc="9" el="132" ec="10">Services\FileUploadController.cs</location>
            <body hash="b0c03f8f972365a4a2c311b0a6f744ac"><![CDATA[{
            for (var i = 0; i < context.Request.Files.Count; i++)
            {
                var file = context.Request.Files[i];
                if (file == null) continue;

                var fileName = Path.GetFileName(file.FileName);

                if (IsAllowedExtension(fileName))
                {
                    var userFolder = _folderManager.GetUserFolder(UserInfo);

                    //todo: deal with the case where the exact file name already exists.
                    var fileInfo = _fileManager.AddFile(userFolder, fileName, file.InputStream, true);
                    var fileIcon = Entities.Icons.IconController.IconURL("Ext" + fileInfo.Extension, "32x32");
                    if (!File.Exists(context.Server.MapPath(fileIcon)))
                    {
                        fileIcon = Entities.Icons.IconController.IconURL("File", "32x32");
                    }
                    statuses.Add(new FilesStatus
                    {
                        success = true,
                        name = fileName,
                        extension = fileInfo.Extension,
                        type = fileInfo.ContentType,
                        size = file.ContentLength,
                        progress = "1.0",
                        url = FileManager.Instance.GetUrl(fileInfo),
                        thumbnail_url = fileIcon,
                        message = "success",
                        id = fileInfo.FileId,
                    });
                }
                else
                {
                    statuses.Add(new FilesStatus
                    {
                        success = false,
                        name = fileName,
                        message = "File type not allowed."
                    });
                }
            }
        }]]></body>
          </codeblock>
        </method>
      </methods>
      <fields>
        <field name="_fileManager">
          <declaration><![CDATA[private readonly IFileManager _fileManager = ComponentBase<IFileManager, FileManager>.Instance;]]></declaration>
          <documentation>
          </documentation>
        </field>
        <field name="_folderManager">
          <declaration><![CDATA[private readonly IFolderManager _folderManager = ComponentBase<IFolderManager, FolderManager>.Instance;]]></declaration>
          <documentation>
          </documentation>
        </field>
        <field name="Logger">
          <declaration><![CDATA[private static readonly ILog Logger = LoggerSource.Instance.GetLogger(typeof(FileUploadController));]]></declaration>
          <documentation>
          </documentation>
        </field>
      </fields>
      <properties>
      </properties>
      <events>
      </events>
    </class>
    <class name="MessagingServiceController">
      <declaration><![CDATA[public class MessagingServiceController : DnnApiController]]></declaration>
      <documentation>
      </documentation>
      <constructors>
        <constructor name=".ctor">
          <declaration><![CDATA[public MessagingServiceController()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="2147483647" sc="0" el="0" ec="0">
            </location>
            <body hash="d41d8cd98f00b204e9800998ecf8427e"><![CDATA[]]></body>
          </codeblock>
        </constructor>
        <constructor name=".cctor">
          <declaration><![CDATA[static MessagingServiceController()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="48" sc="6" el="48" ec="113">Services\MessagingServiceController.cs</location>
            <body hash="ed4c90e446dd297894db67b2ea5a9643"><![CDATA[private static readonly ILog Logger = LoggerSource.Instance.GetLogger(typeof (MessagingServiceController))]]></body>
          </codeblock>
        </constructor>
      </constructors>
      <methods>
        <method name="Archived">
          <declaration><![CDATA[public HttpResponseMessage Archived(int afterMessageId, int numberOfRecords)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="92" sc="9" el="107" ec="10">Services\MessagingServiceController.cs</location>
            <body hash="3292fe405571d018df8855e424d1362f"><![CDATA[{
            try
            {
                var messageBoxView = InternalMessagingController.Instance.GetArchivedMessages(UserInfo.UserID, afterMessageId, numberOfRecords);
                var portalId = PortalController.GetEffectivePortalId(UserController.GetCurrentUserInfo().PortalID);
                messageBoxView.TotalNewThreads = InternalMessagingController.Instance.CountUnreadMessages(UserInfo.UserID, portalId);
                messageBoxView.TotalConversations = InternalMessagingController.Instance.CountArchivedMessages(UserInfo.UserID, portalId);

                return Request.CreateResponse(HttpStatusCode.OK, messageBoxView);
            }
            catch (Exception exc)
            {
                Logger.Error(exc);
                return Request.CreateErrorResponse(HttpStatusCode.InternalServerError, exc);
            }
        }]]></body>
          </codeblock>
        </method>
        <method name="CountNotifications">
          <declaration><![CDATA[public HttpResponseMessage CountNotifications()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="287" sc="9" el="299" ec="10">Services\MessagingServiceController.cs</location>
            <body hash="c0a8f254a20e01b678c404a56cb38f85"><![CDATA[{
            try
            {
                var portalId = PortalController.GetEffectivePortalId(UserController.GetCurrentUserInfo().PortalID);
                int notifications = NotificationsController.Instance.CountNotifications(UserInfo.UserID, portalId);
                return Request.CreateResponse(HttpStatusCode.OK, notifications);
            }
            catch (Exception exc)
            {
                Logger.Error(exc);
                return Request.CreateErrorResponse(HttpStatusCode.InternalServerError, exc);
            }
        }]]></body>
          </codeblock>
        </method>
        <method name="CountUnreadMessages">
          <declaration><![CDATA[public HttpResponseMessage CountUnreadMessages()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="303" sc="9" el="315" ec="10">Services\MessagingServiceController.cs</location>
            <body hash="027eaf7adc19f0a2cced83b18dfd0b73"><![CDATA[{
            try
            {
                var portalId = PortalController.GetEffectivePortalId(UserController.GetCurrentUserInfo().PortalID);
                var unreadMessages = InternalMessagingController.Instance.CountUnreadMessages(UserInfo.UserID, portalId);
                return Request.CreateResponse(HttpStatusCode.OK, unreadMessages);
            }
            catch (Exception exc)
            {
                Logger.Error(exc);
                return Request.CreateErrorResponse(HttpStatusCode.InternalServerError, exc);
            }
        }]]></body>
          </codeblock>
        </method>
        <method name="GetTotals">
          <declaration><![CDATA[public HttpResponseMessage GetTotals()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="319" sc="9" el="336" ec="10">Services\MessagingServiceController.cs</location>
            <body hash="5e4a9d4b75163d89ffa382057067976e"><![CDATA[{
            try
            {
                var portalId = PortalController.GetEffectivePortalId(UserController.GetCurrentUserInfo().PortalID);
                var totalsViewModel = new TotalsViewModel
                {
                    TotalUnreadMessages = InternalMessagingController.Instance.CountUnreadMessages(UserInfo.UserID, portalId),
                    TotalNotifications = NotificationsController.Instance.CountNotifications(UserInfo.UserID, portalId)
                };

                return Request.CreateResponse(HttpStatusCode.OK, totalsViewModel);
            }
            catch (Exception exc)
            {
                Logger.Error(exc);
                return Request.CreateErrorResponse(HttpStatusCode.InternalServerError, exc);
            }
        }]]></body>
          </codeblock>
        </method>
        <method name="Inbox">
          <declaration><![CDATA[public HttpResponseMessage Inbox(int afterMessageId, int numberOfRecords)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="53" sc="9" el="69" ec="10">Services\MessagingServiceController.cs</location>
            <body hash="4e0f1b714cbf47215427ee5042757a2f"><![CDATA[{
            try
            {
                var messageBoxView = InternalMessagingController.Instance.GetRecentInbox(UserInfo.UserID, afterMessageId, numberOfRecords);
                var portalId = PortalController.GetEffectivePortalId(UserController.GetCurrentUserInfo().PortalID);

                messageBoxView.TotalNewThreads = InternalMessagingController.Instance.CountUnreadMessages(UserInfo.UserID, portalId);
                messageBoxView.TotalConversations = InternalMessagingController.Instance.CountConversations(UserInfo.UserID, portalId);

                return Request.CreateResponse(HttpStatusCode.OK, messageBoxView);
            }
            catch (Exception exc)
            {
                Logger.Error(exc);
                return Request.CreateErrorResponse(HttpStatusCode.InternalServerError, exc);
            }
        }]]></body>
          </codeblock>
        </method>
        <method name="LocalizeActionString">
          <declaration><![CDATA[private string LocalizeActionString(string key, int desktopModuleId)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="358" sc="9" el="380" ec="10">Services\MessagingServiceController.cs</location>
            <body hash="8494e791d8c31bd5cbe655f4f6259639"><![CDATA[{
            if (string.IsNullOrEmpty(key)) return "";

            string actionString;

            if (desktopModuleId > 0)
            {
                var desktopModule = DesktopModuleController.GetDesktopModule(desktopModuleId, PortalSettings.PortalId);

                var resourceFile = string.Format("~/DesktopModules/{0}/{1}/{2}",
                    desktopModule.FolderName.Replace("\\", "/"),
                    Localization.LocalResourceDirectory,
                    Localization.LocalSharedResourceFile);

                actionString = Localization.GetString(key, resourceFile);
            }
            else
            {
                actionString = Localization.GetString(key);
            }

            return string.IsNullOrEmpty(actionString) ? key : actionString;
        }]]></body>
          </codeblock>
        </method>
        <method name="MarkArchived">
          <declaration><![CDATA[public HttpResponseMessage MarkArchived(MessagingServiceController.ConversationDTO postData)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="157" sc="9" el="168" ec="10">Services\MessagingServiceController.cs</location>
            <body hash="e52af28694da79f40db4c9af584f707f"><![CDATA[{
            try
            {
                InternalMessagingController.Instance.MarkArchived(postData.ConversationId, UserInfo.UserID);
                return Request.CreateResponse(HttpStatusCode.OK, new {Result = "success"});
            }
            catch (Exception exc)
            {
                Logger.Error(exc);
                return Request.CreateErrorResponse(HttpStatusCode.InternalServerError, exc);
            }
        }]]></body>
          </codeblock>
        </method>
        <method name="MarkRead">
          <declaration><![CDATA[public HttpResponseMessage MarkRead(MessagingServiceController.ConversationDTO postData)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="189" sc="9" el="200" ec="10">Services\MessagingServiceController.cs</location>
            <body hash="cbee45f45934ae75420d22c26fe7fe41"><![CDATA[{
            try
            {
                InternalMessagingController.Instance.MarkRead(postData.ConversationId, UserInfo.UserID);
                return Request.CreateResponse(HttpStatusCode.OK, new {Result = "success"});
            }
            catch (Exception exc)
            {
                Logger.Error(exc);
                return Request.CreateErrorResponse(HttpStatusCode.InternalServerError, exc);
            }
        }]]></body>
          </codeblock>
        </method>
        <method name="MarkUnArchived">
          <declaration><![CDATA[public HttpResponseMessage MarkUnArchived(MessagingServiceController.ConversationDTO postData)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="173" sc="9" el="184" ec="10">Services\MessagingServiceController.cs</location>
            <body hash="1de282267cc306d7eac89cdd08d1e0f8"><![CDATA[{
            try
            {
                InternalMessagingController.Instance.MarkUnArchived(postData.ConversationId, UserInfo.UserID);
                return Request.CreateResponse(HttpStatusCode.OK, new {Result = "success"});
            }
            catch (Exception exc)
            {
                Logger.Error(exc);
                return Request.CreateErrorResponse(HttpStatusCode.InternalServerError, exc);
            }
        }]]></body>
          </codeblock>
        </method>
        <method name="MarkUnRead">
          <declaration><![CDATA[public HttpResponseMessage MarkUnRead(MessagingServiceController.ConversationDTO postData)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="205" sc="9" el="216" ec="10">Services\MessagingServiceController.cs</location>
            <body hash="c51a5e7c20f3aa1a4aa837e9653b45a6"><![CDATA[{
            try
            {
                InternalMessagingController.Instance.MarkUnRead(postData.ConversationId, UserInfo.UserID);
                return Request.CreateResponse(HttpStatusCode.OK, new {Result = "success"});
            }
            catch (Exception exc)
            {
                Logger.Error(exc);
                return Request.CreateErrorResponse(HttpStatusCode.InternalServerError, exc);
            }
        }]]></body>
          </codeblock>
        </method>
        <method name="Notifications">
          <declaration><![CDATA[public HttpResponseMessage Notifications(int afterNotificationId, int numberOfRecords)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="220" sc="9" el="283" ec="10">Services\MessagingServiceController.cs</location>
            <body hash="cabf79007cfa9b5463877f045a678e8e"><![CDATA[{
            try
            {
                var portalId = PortalController.GetEffectivePortalId(UserController.GetCurrentUserInfo().PortalID);
                var notificationsDomainModel = NotificationsController.Instance.GetNotifications(UserInfo.UserID, portalId, afterNotificationId, numberOfRecords);

                var notificationsViewModel = new NotificationsViewModel
                {
                    TotalNotifications = NotificationsController.Instance.CountNotifications(UserInfo.UserID, portalId),
                    Notifications = new List<NotificationViewModel>(notificationsDomainModel.Count)
                };

                foreach (var notification in notificationsDomainModel)
                {
                    var notificationViewModel = new NotificationViewModel
                    {
                        NotificationId = notification.NotificationID,
                        Subject = notification.Subject,
                        From = notification.From,
                        Body = notification.Body,
                        DisplayDate = Common.Utilities.DateUtils.CalculateDateForDisplay(notification.CreatedOnDate),
                        SenderAvatar = string.Format(Globals.UserProfilePicFormattedUrl(), notification.SenderUserID, 64, 64),
                        SenderProfileUrl = Globals.UserProfileURL(notification.SenderUserID),
                        Actions = new List<NotificationActionViewModel>()
                    };

                    var notificationType = NotificationsController.Instance.GetNotificationType(notification.NotificationTypeID);
                    var notificationTypeActions = NotificationsController.Instance.GetNotificationTypeActions(notification.NotificationTypeID);

                    foreach (var notificationTypeAction in notificationTypeActions)
                    {
                        var notificationActionViewModel = new NotificationActionViewModel
                        {
                            Name = LocalizeActionString(notificationTypeAction.NameResourceKey, notificationType.DesktopModuleId),
                            Description = LocalizeActionString(notificationTypeAction.DescriptionResourceKey, notificationType.DesktopModuleId),
                            Confirm = LocalizeActionString(notificationTypeAction.ConfirmResourceKey, notificationType.DesktopModuleId),
                            APICall = notificationTypeAction.APICall
                        };

                        notificationViewModel.Actions.Add(notificationActionViewModel);
                    }

                    if (notification.IncludeDismissAction)
                    {
                        notificationViewModel.Actions.Add(new NotificationActionViewModel
                        {
                            Name = Localization.GetString("Dismiss.Text"),
                            Description = Localization.GetString("DismissNotification.Text"),
                            Confirm = "",
                            APICall = "DesktopModules/InternalServices/API/NotificationsService/Dismiss"
                        });
                    }

                    notificationsViewModel.Notifications.Add(notificationViewModel);
                }

                return Request.CreateResponse(HttpStatusCode.OK, notificationsViewModel);
            }
            catch (Exception exc)
            {
                Logger.Error(exc);
                return Request.CreateErrorResponse(HttpStatusCode.InternalServerError, exc);
            }
        }]]></body>
          </codeblock>
        </method>
        <method name="Reply">
          <declaration><![CDATA[public HttpResponseMessage Reply(MessagingServiceController.ReplyDTO postData)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="133" sc="9" el="152" ec="10">Services\MessagingServiceController.cs</location>
            <body hash="c0876a497bfcb880a3a56e5790a4c6c2"><![CDATA[{
            try
            {
                postData.Body = HttpUtility.UrlDecode(postData.Body);
                var messageId = InternalMessagingController.Instance.ReplyMessage(postData.ConversationId, postData.Body, postData.FileIds);
				var message = ToExpandoObject(InternalMessagingController.Instance.GetMessage(messageId));
                var portalId = PortalController.GetEffectivePortalId(UserController.GetCurrentUserInfo().PortalID);

                var totalNewThreads = InternalMessagingController.Instance.CountUnreadMessages(UserInfo.UserID, portalId);
                var totalThreads = InternalMessagingController.Instance.CountMessagesByConversation(postData.ConversationId);
                var totalArchivedThreads = InternalMessagingController.Instance.CountArchivedMessagesByConversation(postData.ConversationId);

                return Request.CreateResponse(HttpStatusCode.OK, new { Conversation = message, TotalNewThreads = totalNewThreads, TotalThreads = totalThreads, TotalArchivedThreads = totalArchivedThreads });
            }
            catch (Exception exc)
            {
                Logger.Error(exc);
                return Request.CreateErrorResponse(HttpStatusCode.InternalServerError, exc);
            }
        }]]></body>
          </codeblock>
        </method>
        <method name="Sentbox">
          <declaration><![CDATA[public HttpResponseMessage Sentbox(int afterMessageId, int numberOfRecords)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="73" sc="9" el="88" ec="10">Services\MessagingServiceController.cs</location>
            <body hash="69a91943c93d93fdb6542ec1393971c6"><![CDATA[{
            try
            {
                var messageBoxView = InternalMessagingController.Instance.GetRecentSentbox(UserInfo.UserID, afterMessageId, numberOfRecords);
                var portalId = PortalController.GetEffectivePortalId(UserController.GetCurrentUserInfo().PortalID);
                messageBoxView.TotalNewThreads = InternalMessagingController.Instance.CountUnreadMessages(UserInfo.UserID, portalId);
                messageBoxView.TotalConversations = InternalMessagingController.Instance.CountSentMessages(UserInfo.UserID, portalId);

                return Request.CreateResponse(HttpStatusCode.OK, messageBoxView);
            }
            catch (Exception exc)
            {
                Logger.Error(exc);
                return Request.CreateErrorResponse(HttpStatusCode.InternalServerError, exc);
            }
        }]]></body>
          </codeblock>
        </method>
        <method name="Thread">
          <declaration><![CDATA[public HttpResponseMessage Thread(int conversationId, int afterMessageId, int numberOfRecords)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="111" sc="9" el="128" ec="10">Services\MessagingServiceController.cs</location>
            <body hash="5a207342751be3a46d0b7c6acd4c9191"><![CDATA[{
            try
            {
                var totalRecords = 0;
                var messageThreadsView = InternalMessagingController.Instance.GetMessageThread(conversationId, UserInfo.UserID, afterMessageId, numberOfRecords, ref totalRecords);
                var portalId = PortalController.GetEffectivePortalId(UserController.GetCurrentUserInfo().PortalID);
                messageThreadsView.TotalNewThreads = InternalMessagingController.Instance.CountUnreadMessages(UserInfo.UserID, portalId);
                messageThreadsView.TotalThreads = InternalMessagingController.Instance.CountMessagesByConversation(conversationId);
                messageThreadsView.TotalArchivedThreads = InternalMessagingController.Instance.CountArchivedMessagesByConversation(conversationId);

                return Request.CreateResponse(HttpStatusCode.OK, messageThreadsView);
            }
            catch (Exception exc)
            {
                Logger.Error(exc);
                return Request.CreateErrorResponse(HttpStatusCode.InternalServerError, exc);
            }
        }]]></body>
          </codeblock>
        </method>
        <method name="ToExpandoObject">
          <declaration><![CDATA[private dynamic ToExpandoObject(Message message)]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="383" sc="3" el="403" ec="4">Services\MessagingServiceController.cs</location>
            <body hash="18e2d52d5ab4029ec44475bb90d5f1af"><![CDATA[{
			dynamic messageObj = new ExpandoObject();
			messageObj.PortalID = message.PortalID;
			messageObj.KeyID = message.KeyID;
			messageObj.MessageID = message.MessageID;
			messageObj.ConversationId = message.ConversationId;
			messageObj.SenderUserID = message.SenderUserID;
			messageObj.From = message.From;
			messageObj.To = message.To;
			messageObj.Subject = message.Subject;
			messageObj.Body = message.Body;
			messageObj.DisplayDate = message.DisplayDate;
			messageObj.ReplyAllAllowed = message.ReplyAllAllowed;
			//base entity properties
			messageObj.CreatedByUserID = message.CreatedByUserID;
			messageObj.CreatedOnDate = message.CreatedOnDate;
			messageObj.LastModifiedByUserID = message.LastModifiedByUserID;
			messageObj.LastModifiedOnDate = message.LastModifiedOnDate;
			
			return messageObj;
		}]]></body>
          </codeblock>
        </method>
      </methods>
      <fields>
        <field name="Logger">
          <declaration><![CDATA[private static readonly ILog Logger = LoggerSource.Instance.GetLogger(typeof(MessagingServiceController));]]></declaration>
          <documentation>
          </documentation>
        </field>
      </fields>
      <properties>
      </properties>
      <events>
      </events>
    </class>
  </namespace>
  <namespace name="DotNetNuke.Modules.CoreMessaging.ViewModels">
    <class name="NotificationActionViewModel">
      <declaration><![CDATA[public class NotificationActionViewModel]]></declaration>
      <documentation>
      </documentation>
      <constructors>
        <constructor name=".ctor">
          <declaration><![CDATA[public NotificationActionViewModel()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="2147483647" sc="0" el="0" ec="0">
            </location>
            <body hash="d41d8cd98f00b204e9800998ecf8427e"><![CDATA[]]></body>
          </codeblock>
        </constructor>
      </constructors>
      <methods>
      </methods>
      <fields>
      </fields>
      <properties>
        <property name="APICall">
          <declaration><![CDATA[public string APICall]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="Confirm">
          <declaration><![CDATA[public string Confirm]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="Description">
          <declaration><![CDATA[public string Description]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="Name">
          <declaration><![CDATA[public string Name]]></declaration>
          <documentation>
          </documentation>
        </property>
      </properties>
      <events>
      </events>
    </class>
    <class name="NotificationsViewModel">
      <declaration><![CDATA[public class NotificationsViewModel]]></declaration>
      <documentation>
      </documentation>
      <constructors>
        <constructor name=".ctor">
          <declaration><![CDATA[public NotificationsViewModel()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="2147483647" sc="0" el="0" ec="0">
            </location>
            <body hash="d41d8cd98f00b204e9800998ecf8427e"><![CDATA[]]></body>
          </codeblock>
        </constructor>
      </constructors>
      <methods>
      </methods>
      <fields>
      </fields>
      <properties>
        <property name="Notifications">
          <declaration><![CDATA[public IList<NotificationViewModel> Notifications]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="TotalNotifications">
          <declaration><![CDATA[public int TotalNotifications]]></declaration>
          <documentation>
          </documentation>
        </property>
      </properties>
      <events>
      </events>
    </class>
    <class name="NotificationViewModel">
      <declaration><![CDATA[public class NotificationViewModel]]></declaration>
      <documentation>
      </documentation>
      <constructors>
        <constructor name=".ctor">
          <declaration><![CDATA[public NotificationViewModel()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="2147483647" sc="0" el="0" ec="0">
            </location>
            <body hash="d41d8cd98f00b204e9800998ecf8427e"><![CDATA[]]></body>
          </codeblock>
        </constructor>
      </constructors>
      <methods>
      </methods>
      <fields>
      </fields>
      <properties>
        <property name="Actions">
          <declaration><![CDATA[public IList<NotificationActionViewModel> Actions]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="Body">
          <declaration><![CDATA[public string Body]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="DisplayDate">
          <declaration><![CDATA[public string DisplayDate]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="From">
          <declaration><![CDATA[public string From]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="NotificationId">
          <declaration><![CDATA[public int NotificationId]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="SenderAvatar">
          <declaration><![CDATA[public string SenderAvatar]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="SenderProfileUrl">
          <declaration><![CDATA[public string SenderProfileUrl]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="Subject">
          <declaration><![CDATA[public string Subject]]></declaration>
          <documentation>
          </documentation>
        </property>
      </properties>
      <events>
      </events>
    </class>
    <class name="TotalsViewModel">
      <declaration><![CDATA[public class TotalsViewModel]]></declaration>
      <documentation>
      </documentation>
      <constructors>
        <constructor name=".ctor">
          <declaration><![CDATA[public TotalsViewModel()]]></declaration>
          <documentation>
          </documentation>
          <codeblock>
            <location sl="2147483647" sc="0" el="0" ec="0">
            </location>
            <body hash="d41d8cd98f00b204e9800998ecf8427e"><![CDATA[]]></body>
          </codeblock>
        </constructor>
      </constructors>
      <methods>
      </methods>
      <fields>
      </fields>
      <properties>
        <property name="TotalNotifications">
          <declaration><![CDATA[public int TotalNotifications]]></declaration>
          <documentation>
          </documentation>
        </property>
        <property name="TotalUnreadMessages">
          <declaration><![CDATA[public int TotalUnreadMessages]]></declaration>
          <documentation>
          </documentation>
        </property>
      </properties>
      <events>
      </events>
    </class>
  </namespace>
</root>